// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider             = "prisma-client-py"
  interface            = "asyncio"
  recursive_type_depth = 5
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User management
model User {
  id            String    @id @default(uuid())
  clerkId       String    @unique
  email         String    @unique
  firstName     String?
  lastName      String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Admin access
  isAdmin       Boolean   @default(false)

  // Subscription info
  subscriptionTier      String  @default("free")  // "free", "pro", "team", "enterprise"
  subscriptionStatus    String  @default("active")  // "active", "cancelled", "expired"
  stripeCustomerId      String?
  stripeSubscriptionId  String?

  analyses         Analysis[]
  crmConnections   CRMConnection[]
  scheduledReviews ScheduledReview[]
  outputTemplates  OutputTemplate[]

  // Organization membership
  memberships      OrgMembership[]
  invitationsSent  OrgInvitation[]  @relation("InvitedBy")

  // Custom rules
  customRules      CustomRule[]
  ruleOverrides    GlobalRuleOverride[]

  @@map("users")
}

// Analysis session
model Analysis {
  id              String            @id @default(uuid())
  userId          String
  fileName        String
  fileUrl         String?
  uploadDate      DateTime          @default(now())
  processingStatus ProcessingStatus @default(PENDING)
  errorMessage    String?

  // Summary metrics
  totalDeals      Int               @default(0)
  dealsWithIssues Int               @default(0)
  healthScore     Float             @default(0)

  // Metadata
  totalAmount     Float?
  avgDealSize     Float?
  totalCritical   Int               @default(0)
  totalWarnings   Int               @default(0)

  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  completedAt     DateTime?

  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  deals           Deal[]

  @@index([userId])
  @@index([processingStatus])
  @@map("analyses")
}

enum ProcessingStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

// Deal/Opportunity
model Deal {
  id                String    @id @default(uuid())
  analysisId        String

  // Core fields (normalized from CSV)
  externalId        String?   // Original deal ID from CRM
  name              String
  accountName       String?
  accountId         String?

  // Financial
  amount            Float?
  currency          String?   @default("USD")

  // Dates
  closeDate         DateTime?
  createdDate       DateTime?
  lastActivityDate  DateTime?

  // Sales process
  stage             String?
  probability       Float?
  forecastCategory  String?

  // Ownership
  ownerName         String?
  ownerEmail        String?

  // Contact info
  contactName       String?
  contactEmail      String?
  contactPhone      String?

  // Additional context
  leadSource        String?
  industry          String?
  type              String?
  description       String?
  nextSteps         String?

  // Custom fields (stored as JSON)
  customFields      Json?

  // Analysis results
  hasIssues         Boolean   @default(false)
  criticalCount     Int       @default(0)
  warningCount      Int       @default(0)
  infoCount         Int       @default(0)

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  analysis          Analysis  @relation(fields: [analysisId], references: [id], onDelete: Cascade)
  violations        Violation[]

  @@index([analysisId])
  @@index([hasIssues])
  @@map("deals")
}

// Rule violation
model Violation {
  id                  String         @id @default(uuid())
  dealId              String

  // Rule identification
  ruleId              String
  ruleName            String
  ruleCategory        ViolationCategory

  // Violation details
  severity            Severity
  message             String
  fieldName           String?
  currentValue        String?
  expectedValue       String?

  // Remediation
  remediationAction   String?
  remediationOwner    String?        // "Rep", "Manager", "Auto"
  automatable         Boolean        @default(false)

  // Metadata
  detectedAt          DateTime       @default(now())
  acknowledged        Boolean        @default(false)

  deal                Deal           @relation(fields: [dealId], references: [id], onDelete: Cascade)

  @@index([dealId])
  @@index([severity])
  @@index([ruleCategory])
  @@map("violations")
}

enum Severity {
  CRITICAL
  WARNING
  INFO
}

enum ViolationCategory {
  DATA_QUALITY
  SALES_HYGIENE
  FORECASTING
  PROGRESSION
  ENGAGEMENT
  COMPLIANCE
}

// Business rules configuration (cached in DB)
model BusinessRule {
  id              String            @id @default(uuid())
  ruleId          String            @unique
  name            String
  category        ViolationCategory
  severity        Severity
  description     String
  enabled         Boolean           @default(true)

  // Rule logic
  condition       Json              // Stored rule condition
  message         String
  remediation     String?

  // Configuration
  applicableStages String[]         // Which stages this rule applies to
  priority        Int               @default(0)

  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@map("business_rules")
}

// Field mapping configuration (cached in DB)
model FieldMapping {
  id              String    @id @default(uuid())
  standardField   String    @unique
  aliases         String[]  // Common variations
  required        Boolean   @default(false)
  dataType        String    // "string", "number", "date", "currency"
  description     String?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@map("field_mappings")
}

// CRM Connection (Salesforce OAuth / HubSpot Private App)
model CRMConnection {
  id              String   @id @default(uuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  provider        String   // "salesforce" | "hubspot"

  // Encrypted tokens
  accessToken     String   @db.Text
  refreshToken    String?  @db.Text  // Optional: Only for OAuth (Salesforce)
  instanceUrl     String?  // Salesforce instance URL
  portalId        String?  // HubSpot portal ID

  expiresAt       DateTime?  // Optional: Only for OAuth (Salesforce)

  // Connection metadata
  accountName     String?  // Friendly name for this connection
  isActive        Boolean  @default(true)
  lastSyncAt      DateTime?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  scheduledReviews ScheduledReview[]

  @@unique([userId, provider])
  @@index([userId, isActive])
  @@map("crm_connections")
}

// Scheduled Review Configuration
model ScheduledReview {
  id                String   @id @default(uuid())
  userId            String
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  name              String   // "Weekly Pipeline Review"
  description       String?  // Optional description

  crmConnectionId   String
  crmConnection     CRMConnection @relation(fields: [crmConnectionId], references: [id], onDelete: Cascade)

  // Schedule configuration (cron format)
  // "0 6 * * 1" = Monday at 6am
  // "0 6 * * *" = Every day at 6am
  // "0 6 * * 1,3,5" = Mon, Wed, Fri at 6am
  schedule          String
  timezone          String   @default("America/New_York")

  // Delivery settings (for Session 22)
  deliveryChannels  Json     @default("[]")  // ["email", "slack"]
  emailRecipients   String[] // Email addresses
  slackWebhookUrl   String?  // Slack webhook

  // Template (for Session 22)
  templateId        String?  // Custom template
  outputTemplate    OutputTemplate? @relation(fields: [templateId], references: [id])

  isActive          Boolean  @default(true)

  lastRunAt         DateTime?
  nextRunAt         DateTime?

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  runs              ReviewRun[]

  @@index([userId, isActive])
  @@index([nextRunAt, isActive])
  @@map("scheduled_reviews")
}

// Review Run History
model ReviewRun {
  id                String   @id @default(uuid())
  scheduledReviewId String
  scheduledReview   ScheduledReview @relation(fields: [scheduledReviewId], references: [id], onDelete: Cascade)

  status            String   @default("queued")  // "queued" | "running" | "completed" | "failed"

  startedAt         DateTime @default(now())
  completedAt       DateTime?

  // Results
  dealsAnalyzed     Int?
  healthScore       Int?
  issuesFound       Int?
  highRiskDeals     Int?

  // Error tracking
  errorMessage      String?  @db.Text
  retryCount        Int      @default(0)

  // Link to analysis (for web view)
  analysisId        String?

  // Job metadata
  jobId             String?  // RQ job ID

  createdAt         DateTime @default(now())

  @@index([scheduledReviewId, status])
  @@index([status, startedAt])
  @@map("review_runs")
}

// Output Template for Email/Slack
model OutputTemplate {
  id              String   @id @default(uuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  name            String   // "Executive Summary Style"
  description     String?  // "Focused on top risks"

  // Template content
  emailSubject    String   // "Pipeline Review: {{health_score}}/100"
  emailTemplate   String   @db.Text  // Jinja2 template
  slackTemplate   String   @db.Text  // Jinja2 template

  // Wrapper text
  introText       String?  @db.Text  // Before results
  outroText       String?  @db.Text  // After results

  isDefault       Boolean  @default(false)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  scheduledReviews ScheduledReview[]

  @@index([userId])
  @@map("output_templates")
}

// ===========================================
// ORGANIZATION / TEAM MANAGEMENT
// ===========================================

model Organization {
  id               String   @id @default(uuid())
  name             String
  slug             String   @unique
  planTier         String   @default("team")  // "team", "enterprise"
  settings         Json?
  stripeCustomerId String?

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  memberships      OrgMembership[]
  invitations      OrgInvitation[]
  customRules      CustomRule[]
  ruleOverrides    GlobalRuleOverride[]

  @@map("organizations")
}

model OrgMembership {
  id        String   @id @default(uuid())
  orgId     String
  userId    String
  role      String   @default("ae")  // "admin", "manager", "ae"
  reportsTo String?  // userId of manager
  isActive  Boolean  @default(true)
  joinedAt  DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([orgId, userId])
  @@index([orgId, isActive])
  @@index([userId, isActive])
  @@map("org_memberships")
}

model OrgInvitation {
  id         String    @id @default(uuid())
  orgId      String
  invitedBy  String
  email      String
  role       String    @default("ae")
  reportsTo  String?
  token      String    @unique @default(uuid())
  status     String    @default("pending")  // "pending", "accepted", "declined", "expired"
  expiresAt  DateTime
  acceptedAt DateTime?

  createdAt  DateTime  @default(now())

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  inviter      User         @relation("InvitedBy", fields: [invitedBy], references: [id], onDelete: Cascade)

  @@index([orgId, status])
  @@index([email, status])
  @@map("org_invitations")
}

// ===========================================
// CUSTOM BUSINESS RULES
// ===========================================

model CustomRule {
  id                    String   @id @default(uuid())

  // Ownership: either user-level OR org-level (mutually exclusive)
  userId                String?
  orgId                 String?

  // Rule definition
  ruleId                String            // e.g., "custom_001"
  name                  String
  category              ViolationCategory
  severity              Severity
  description           String
  condition             Json              // Rule condition logic
  message               String
  remediation           String?
  remediationOwner      String?           // "Rep", "Manager", "Auto"
  automatable           Boolean           @default(false)
  applicableStages      String[]
  priority              Int               @default(0)
  enabled               Boolean           @default(true)

  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt

  user                  User?             @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization          Organization?     @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([userId, ruleId])
  @@unique([orgId, ruleId])
  @@index([userId, enabled])
  @@index([orgId, enabled])
  @@map("custom_rules")
}

model GlobalRuleOverride {
  id                    String   @id @default(uuid())

  // Ownership: either user-level OR org-level (mutually exclusive)
  userId                String?
  orgId                 String?

  globalRuleId          String            // e.g., "dq_001" - references the YAML rule
  enabled               Boolean           @default(true)  // Toggle on/off
  thresholdOverrides    Json?             // e.g., {"value": 45} to change threshold

  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt

  user                  User?             @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization          Organization?     @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([userId, globalRuleId])
  @@unique([orgId, globalRuleId])
  @@index([userId])
  @@index([orgId])
  @@map("global_rule_overrides")
}

// ===========================================
// LLM PROVIDER & PROMPT MANAGEMENT
// ===========================================

model LLMProvider {
  id              String   @id @default(uuid())
  name            String   @unique  // "anthropic", "openai", "gemini"
  displayName     String   // "Anthropic Claude", "OpenAI GPT", "Google Gemini"

  // Encrypted API key (encrypted at rest using Fernet)
  apiKeyEncrypted String   @db.Text

  // Provider status
  isActive        Boolean  @default(true)

  // Available models (JSON array)
  // e.g., ["claude-sonnet-4-20250514", "claude-opus-4-20250514"]
  availableModels Json     @default("[]")

  // Default model for this provider
  defaultModel    String?

  // Metadata
  lastTestedAt    DateTime?
  testStatus      String?  // "success", "failed", "untested"

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  createdBy       String   // User ID who created

  // Relations
  prompts         Prompt[]
  promptVersions  PromptVersion[]

  @@map("llm_providers")
}

model Prompt {
  id              String   @id @default(uuid())

  // Unique identifier for the prompt (e.g., "deal_analysis", "field_mapping")
  slug            String   @unique
  name            String   // Display name: "Deal Analysis"
  description     String   @db.Text  // Description of what this prompt does
  category        PromptCategory

  // Default provider/model for this prompt
  providerId      String
  provider        LLMProvider @relation(fields: [providerId], references: [id])
  model           String   // Default model

  // Active version (when not running an experiment)
  activeVersionId String?

  // Execution settings
  maxTokens       Int      @default(2000)
  temperature     Float    @default(0)

  // Future: org/team customization (nullable for global)
  organizationId  String?

  // Metadata
  isSystemPrompt  Boolean  @default(true)  // System prompts cannot be deleted
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  versions        PromptVersion[]
  experiments     PromptExperiment[]
  usageLogs       PromptUsageLog[]

  @@index([slug])
  @@index([category])
  @@index([organizationId])
  @@map("prompts")
}

enum PromptCategory {
  ANALYSIS
  MAPPING
  FORECASTING
  RESEARCH
}

model PromptVersion {
  id              String   @id @default(uuid())
  promptId        String
  prompt          Prompt   @relation(fields: [promptId], references: [id], onDelete: Cascade)

  // Version number (auto-increment per prompt)
  version         Int

  // The actual prompt content (supports template variables)
  content         String   @db.Text

  // Optional override of provider/model for this version
  providerId      String?
  provider        LLMProvider? @relation(fields: [providerId], references: [id])
  model           String?

  // Metadata
  changeNote      String?  // "Improved risk factor descriptions"
  createdAt       DateTime @default(now())
  createdBy       String   // User ID

  // Relations
  controlExperiments   PromptExperiment[] @relation("ControlVersion")
  treatmentExperiments PromptExperiment[] @relation("TreatmentVersion")
  usageLogs            PromptUsageLog[]

  @@unique([promptId, version])
  @@index([promptId])
  @@map("prompt_versions")
}

enum ExperimentStatus {
  DRAFT
  RUNNING
  COMPLETED
  CANCELLED
}

model PromptExperiment {
  id                  String           @id @default(uuid())
  promptId            String
  prompt              Prompt           @relation(fields: [promptId], references: [id], onDelete: Cascade)

  name                String           // "Test new risk scoring prompt"
  description         String?

  // Variants
  controlVersionId    String
  controlVersion      PromptVersion    @relation("ControlVersion", fields: [controlVersionId], references: [id])
  treatmentVersionId  String
  treatmentVersion    PromptVersion    @relation("TreatmentVersion", fields: [treatmentVersionId], references: [id])

  // Traffic split (0.0 to 1.0 = % going to treatment)
  trafficSplit        Float            @default(0.5)

  // Status
  status              ExperimentStatus @default(DRAFT)
  startedAt           DateTime?
  endedAt             DateTime?

  // Results (aggregated metrics)
  controlInvocations  Int              @default(0)
  treatmentInvocations Int             @default(0)
  controlAvgLatencyMs Float?
  treatmentAvgLatencyMs Float?
  controlAvgTokens    Float?
  treatmentAvgTokens  Float?
  controlErrorRate    Float?
  treatmentErrorRate  Float?

  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt
  createdBy           String

  @@index([promptId, status])
  @@map("prompt_experiments")
}

model PromptUsageLog {
  id              String   @id @default(uuid())
  promptId        String
  prompt          Prompt   @relation(fields: [promptId], references: [id], onDelete: Cascade)
  versionId       String
  version         PromptVersion @relation(fields: [versionId], references: [id], onDelete: Cascade)

  // Execution metrics
  latencyMs       Int
  inputTokens     Int
  outputTokens    Int
  totalTokens     Int
  success         Boolean
  errorMessage    String?  @db.Text

  // Context
  userId          String?
  experimentId    String?

  createdAt       DateTime @default(now())

  @@index([promptId, createdAt])
  @@index([versionId])
  @@index([experimentId])
  @@map("prompt_usage_logs")
}

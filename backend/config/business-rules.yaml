# Business Rules Configuration for RevTrust
# Defines all validation rules for pipeline hygiene

version: "1.0"

# Rule categories
categories:
  data_quality: "DATA_QUALITY"
  sales_hygiene: "SALES_HYGIENE"
  forecasting: "FORECASTING"
  progression: "PROGRESSION"
  engagement: "ENGAGEMENT"
  compliance: "COMPLIANCE"

# ============================================================================
# DATA QUALITY RULES
# ============================================================================

data_quality_rules:
  - id: "dq_001"
    name: "Missing Deal Name"
    category: "DATA_QUALITY"
    severity: "CRITICAL"
    description: "Deal must have a name"
    condition:
      field: "deal_name"
      operator: "is_empty"
    message: "Deal is missing a name"
    remediation: "Add a descriptive deal name that identifies the opportunity"
    remediation_owner: "Rep"
    automatable: false

  - id: "dq_002"
    name: "Missing Account Name"
    category: "DATA_QUALITY"
    severity: "CRITICAL"
    description: "Deal must have an associated account"
    condition:
      field: "account_name"
      operator: "is_empty"
    message: "Deal is missing account name"
    remediation: "Associate this deal with a valid account"
    remediation_owner: "Rep"
    automatable: false

  - id: "dq_003"
    name: "Missing Amount"
    category: "DATA_QUALITY"
    severity: "CRITICAL"
    description: "Deal must have an amount"
    condition:
      field: "amount"
      operator: "is_null_or_zero"
    message: "Deal has no amount or is set to $0"
    remediation: "Update deal with accurate amount based on quote or estimate"
    remediation_owner: "Rep"
    automatable: false

  - id: "dq_004"
    name: "Missing Close Date"
    category: "DATA_QUALITY"
    severity: "CRITICAL"
    description: "Deal must have a close date"
    condition:
      field: "close_date"
      operator: "is_empty"
    message: "Deal is missing expected close date"
    remediation: "Set realistic close date based on sales cycle"
    remediation_owner: "Rep"
    automatable: false

  - id: "dq_005"
    name: "Missing Stage"
    category: "DATA_QUALITY"
    severity: "CRITICAL"
    description: "Deal must have a stage"
    condition:
      field: "stage"
      operator: "is_empty"
    message: "Deal is missing pipeline stage"
    remediation: "Set current stage based on deal progress"
    remediation_owner: "Rep"
    automatable: false

  - id: "dq_006"
    name: "Missing Owner"
    category: "DATA_QUALITY"
    severity: "CRITICAL"
    description: "Deal must have an owner"
    condition:
      field: "owner_name"
      operator: "is_empty"
    message: "Deal has no assigned owner"
    remediation: "Assign deal to appropriate sales rep"
    remediation_owner: "Manager"
    automatable: true

  - id: "dq_007"
    name: "Unrealistic Deal Amount"
    category: "DATA_QUALITY"
    severity: "WARNING"
    description: "Deal amount seems unrealistic"
    condition:
      any:
        - field: "amount"
          operator: "greater_than"
          value: 10000000
        - field: "amount"
          operator: "less_than"
          value: 100
    message: "Deal amount is unusually high or low"
    remediation: "Verify deal amount is accurate"
    remediation_owner: "Rep"
    automatable: false

# ============================================================================
# SALES HYGIENE RULES
# ============================================================================

sales_hygiene_rules:
  - id: "sh_001"
    name: "Close Date in Past"
    category: "SALES_HYGIENE"
    severity: "CRITICAL"
    description: "Close date should not be in the past for open deals"
    condition:
      field: "close_date"
      operator: "is_past"
    message: "Deal has a close date in the past but is still open"
    remediation: "Either close the deal (won/lost) or update to realistic future close date"
    remediation_owner: "Rep"
    automatable: false
    applicable_stages:
      - "all_except_closed"

  - id: "sh_002"
    name: "Stale Deal - No Recent Activity"
    category: "SALES_HYGIENE"
    severity: "WARNING"
    description: "Deal has had no activity in 30+ days"
    condition:
      field: "last_activity_date"
      operator: "older_than_days"
      value: 30
    message: "No activity recorded in the last 30 days"
    remediation: "Update deal with recent activity or move to closed-lost"
    remediation_owner: "Rep"
    automatable: false
    applicable_stages:
      - "all_except_closed"

  - id: "sh_003"
    name: "Long Sales Cycle"
    category: "SALES_HYGIENE"
    severity: "WARNING"
    description: "Deal has been open for unusually long time"
    condition:
      field: "created_date"
      operator: "older_than_days"
      value: 180
    message: "Deal has been open for more than 6 months"
    remediation: "Review deal qualification and likelihood to close"
    remediation_owner: "Manager"
    automatable: false
    applicable_stages:
      - "all_except_closed"

  - id: "sh_004"
    name: "Missing Next Steps"
    category: "SALES_HYGIENE"
    severity: "WARNING"
    description: "Deal should have defined next steps"
    condition:
      field: "next_steps"
      operator: "is_empty"
    message: "No next steps defined"
    remediation: "Document clear next steps to move deal forward"
    remediation_owner: "Rep"
    automatable: false
    applicable_stages:
      - "Discovery"
      - "Qualification"
      - "Proposal"
      - "Negotiation"

  - id: "sh_005"
    name: "Missing Primary Contact"
    category: "SALES_HYGIENE"
    severity: "WARNING"
    description: "Deal should have primary contact information"
    condition:
      field: "contact_name"
      operator: "is_empty"
    message: "No primary contact assigned to deal"
    remediation: "Add primary decision maker or champion contact"
    remediation_owner: "Rep"
    automatable: false

# ============================================================================
# FORECASTING RULES
# ============================================================================

forecasting_rules:
  - id: "fc_001"
    name: "Closing This Month - Low Probability"
    category: "FORECASTING"
    severity: "WARNING"
    description: "Deal closing this month should have high probability"
    condition:
      all:
        - field: "close_date"
          operator: "within_days"
          value: 30
        - field: "probability"
          operator: "less_than"
          value: 70
    message: "Deal is expected to close this month but has low probability"
    remediation: "Update close date or increase deal progression"
    remediation_owner: "Rep"
    automatable: false

  - id: "fc_002"
    name: "Early Stage with Near Close Date"
    category: "FORECASTING"
    severity: "WARNING"
    description: "Early stage deals should not close soon"
    condition:
      all:
        - field: "stage"
          operator: "in"
          value: ["Prospecting", "Qualification", "Discovery"]
        - field: "close_date"
          operator: "within_days"
          value: 45
    message: "Deal is in early stage but close date is less than 45 days away"
    remediation: "Update close date to allow for proper sales cycle"
    remediation_owner: "Rep"
    automatable: false

  - id: "fc_003"
    name: "Late Stage with Distant Close Date"
    category: "FORECASTING"
    severity: "WARNING"
    description: "Late stage deals should close soon"
    condition:
      all:
        - field: "stage"
          operator: "in"
          value: ["Proposal", "Negotiation", "Verbal Commit"]
        - field: "close_date"
          operator: "more_than_days_away"
          value: 60
    message: "Deal is in late stage but close date is more than 60 days away"
    remediation: "Review if deal is truly in late stage or update close date"
    remediation_owner: "Manager"
    automatable: false

  - id: "fc_004"
    name: "Probability Doesn't Match Stage"
    category: "FORECASTING"
    severity: "WARNING"
    description: "Probability should align with stage"
    condition:
      any:
        - all:
            - field: "stage"
              operator: "in"
              value: ["Prospecting", "Qualification"]
            - field: "probability"
              operator: "greater_than"
              value: 30
        - all:
            - field: "stage"
              operator: "in"
              value: ["Proposal", "Negotiation"]
            - field: "probability"
              operator: "less_than"
              value: 50
        - all:
            - field: "stage"
              operator: "equals"
              value: "Verbal Commit"
            - field: "probability"
              operator: "less_than"
              value: 80
    message: "Probability doesn't align with current stage"
    remediation: "Update probability to match stage or verify stage is accurate"
    remediation_owner: "Rep"
    automatable: true

  - id: "fc_005"
    name: "Missing Forecast Category"
    category: "FORECASTING"
    severity: "WARNING"
    description: "Deals closing this quarter should have forecast category"
    condition:
      all:
        - field: "close_date"
          operator: "within_days"
          value: 90
        - field: "forecast_category"
          operator: "is_empty"
    message: "Deal closing this quarter has no forecast category"
    remediation: "Set forecast category (Pipeline, Best Case, Commit, etc.)"
    remediation_owner: "Rep"
    automatable: false

# ============================================================================
# PROGRESSION RULES
# ============================================================================

progression_rules:
  - id: "pr_001"
    name: "Stuck in Discovery"
    category: "PROGRESSION"
    severity: "WARNING"
    description: "Deal has been in Discovery stage too long"
    condition:
      all:
        - field: "stage"
          operator: "equals"
          value: "Discovery"
        - field: "last_activity_date"
          operator: "older_than_days"
          value: 45
    message: "Deal has been stuck in Discovery for 45+ days"
    remediation: "Advance to Qualification or close as lost"
    remediation_owner: "Rep"
    automatable: false

  - id: "pr_002"
    name: "Stuck in Proposal"
    category: "PROGRESSION"
    severity: "WARNING"
    description: "Deal has been in Proposal stage too long"
    condition:
      all:
        - field: "stage"
          operator: "equals"
          value: "Proposal"
        - field: "last_activity_date"
          operator: "older_than_days"
          value: 30
    message: "Deal has been stuck in Proposal for 30+ days"
    remediation: "Move to Negotiation or reassess deal status"
    remediation_owner: "Rep"
    automatable: false

  - id: "pr_003"
    name: "Stuck in Negotiation"
    category: "PROGRESSION"
    severity: "CRITICAL"
    description: "Deal has been in Negotiation too long"
    condition:
      all:
        - field: "stage"
          operator: "equals"
          value: "Negotiation"
        - field: "last_activity_date"
          operator: "older_than_days"
          value: 20
    message: "Deal has been stuck in Negotiation for 20+ days"
    remediation: "Close deal or identify and resolve blockers"
    remediation_owner: "Manager"
    automatable: false

  - id: "pr_004"
    name: "Quick Progression Warning"
    category: "PROGRESSION"
    severity: "INFO"
    description: "Deal moved through pipeline very quickly"
    condition:
      all:
        - field: "stage"
          operator: "in"
          value: ["Proposal", "Negotiation", "Verbal Commit"]
        - field: "created_date"
          operator: "within_days"
          value: 7
    message: "Deal moved to late stage within 7 days of creation"
    remediation: "Verify all qualification steps were completed"
    remediation_owner: "Manager"
    automatable: false

# ============================================================================
# ENGAGEMENT RULES
# ============================================================================

engagement_rules:
  - id: "en_001"
    name: "No Recent Activity - Closing Soon"
    category: "ENGAGEMENT"
    severity: "CRITICAL"
    description: "Deal closing soon should have recent activity"
    condition:
      all:
        - field: "close_date"
          operator: "within_days"
          value: 30
        - field: "last_activity_date"
          operator: "older_than_days"
          value: 7
    message: "Deal closes in 30 days but no activity in last 7 days"
    remediation: "Engage with prospect immediately or update close date"
    remediation_owner: "Rep"
    automatable: false

  - id: "en_002"
    name: "No Activity Since Creation"
    category: "ENGAGEMENT"
    severity: "WARNING"
    description: "Deal should have activity after creation"
    condition:
      all:
        - field: "last_activity_date"
          operator: "is_empty"
        - field: "created_date"
          operator: "older_than_days"
          value: 7
    message: "No activity recorded since deal was created 7+ days ago"
    remediation: "Log activity or close deal if not being pursued"
    remediation_owner: "Rep"
    automatable: false

  - id: "en_003"
    name: "Missing Contact Information"
    category: "ENGAGEMENT"
    severity: "WARNING"
    description: "Should have contact email or phone"
    condition:
      all:
        - field: "contact_email"
          operator: "is_empty"
        - field: "contact_phone"
          operator: "is_empty"
    message: "No contact email or phone number on file"
    remediation: "Add contact information for primary decision maker"
    remediation_owner: "Rep"
    automatable: false

# ============================================================================
# COMPLIANCE RULES
# ============================================================================

compliance_rules:
  - id: "co_001"
    name: "Large Deal Missing Approval"
    category: "COMPLIANCE"
    severity: "CRITICAL"
    description: "Deals over $100k require manager approval"
    condition:
      all:
        - field: "amount"
          operator: "greater_than"
          value: 100000
        - field: "stage"
          operator: "in"
          value: ["Proposal", "Negotiation", "Verbal Commit"]
        # Custom field check would go here
    message: "Deal over $100k in late stage requires manager approval"
    remediation: "Obtain manager approval before proceeding"
    remediation_owner: "Manager"
    automatable: false

  - id: "co_002"
    name: "Deal Type Not Specified"
    category: "COMPLIANCE"
    severity: "WARNING"
    description: "Deal type should be specified for reporting"
    condition:
      field: "type"
      operator: "is_empty"
    message: "Deal type not specified (New Business, Renewal, Upsell, etc.)"
    remediation: "Categorize deal type for accurate reporting"
    remediation_owner: "Rep"
    automatable: false

# ============================================================================
# RULE OPERATORS
# ============================================================================

operators:
  is_empty:
    description: "Field is null, empty string, or whitespace only"
  is_null_or_zero:
    description: "Field is null or equals zero"
  is_past:
    description: "Date is before today"
  older_than_days:
    description: "Date is more than N days ago"
  within_days:
    description: "Date is within the next N days"
  more_than_days_away:
    description: "Date is more than N days in the future"
  greater_than:
    description: "Numeric value is greater than N"
  less_than:
    description: "Numeric value is less than N"
  equals:
    description: "Value equals specified value"
  in:
    description: "Value is in list of specified values"

# ============================================================================
# STAGE DEFINITIONS
# ============================================================================

stages:
  standard_pipeline:
    - name: "Prospecting"
      probability: 10
      expected_days: 14
    - name: "Qualification"
      probability: 20
      expected_days: 21
    - name: "Discovery"
      probability: 30
      expected_days: 30
    - name: "Proposal"
      probability: 60
      expected_days: 21
    - name: "Negotiation"
      probability: 75
      expected_days: 14
    - name: "Verbal Commit"
      probability: 90
      expected_days: 7
    - name: "Closed Won"
      probability: 100
      expected_days: 0
    - name: "Closed Lost"
      probability: 0
      expected_days: 0
